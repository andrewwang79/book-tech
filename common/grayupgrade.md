# 灰度升级
* 功能逐级发布
* 本质是流量治理，逐级分配流量到不同环境
* facebook的机制, gatekeeper

## 方案
* 本质上是个功能的路由器，可重定向，可关闭。
* 每个功能都有发布级别，上下线
* 分流控制：可指定特定地域，用户级别等
* 每个发布控制点关联一个功能编码
* 功能的发布级别是可以管理配置的。支持手工调整和自动调整(如3天升一级)
* 用户选择随机性确保：功能编码做随机数种子。

## 发布级别

| 级别 | 范围 | 说明 |
| :----: | ---- | ---- |
| 1 | 公司内部 | 内测 |
| 2 | 1% | 外部小范围，忠诚度较高的种子用户/活跃用户 |
| 3 | 5% | 外部大范围 |
| n | 100% | 发布 |

## 流程
* 前端一次性下载(周期性更新)：用户级别，功能级别(发布中的功能，不是全部功能)。
* 用户级别足够，则显示功能，否则隐藏。

# 资料
* [灰度发布](http://arganzheng.life/gray-release.html)
* [使用Nginx实现Web应用灰度发布](https://www.jianshu.com/p/e89ad8748764)，cookie,ip
* [BAT 公司是怎样做产品灰度发布的？](https://www.zhihu.com/question/28296375)
* [AB测试和灰度发布平台架构设计和实践](http://doc.mbalib.com/view/1622be0db26dc1400284e0ea95fd2f80.html)

## AB测试
* 可以用灰度发布，也可以用功能切换(1套服务)
* 用户有功能版本列表(功能+AB版本)，不同功能间的版本是独立的。
* 功能版本列表存放在本地，如cookie。
* 没有功能版本则使用功能前自动分配。
* 分流控制：等比例分配。如2个版本各是50%，5个版本各是20%。
* 每个功能版本都有其页面版本包(页面和逻辑)。通过用户版本自动加载不同的页面和逻辑。
* 测试完成后，可以全部使用选中的版本。
